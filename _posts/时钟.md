---
layout: post
title:  "计算机时钟介绍"
date:   2022-01-23 00:00:01 +0800
---

 现代计算机至少有两种不同的时钟：日历时钟（time-of-day clock）和单调钟（monotonic clock）。

#### [日历时钟](http://ddia.vonng.com/#/ch8?id=日历时钟)

 日历时钟是您直观地了解时钟的依据：它根据某个日历（返回当前日期和时间。例如，Linux上的`clock_gettime(CLOCK_REALTIME)`，虽然该时钟被称为实时时钟，但它与实时操作系统无关。和Java中的`System.currentTimeMillis()`返回自epoch（UTC时间1970年1月1日午夜）以来的秒数（或毫秒），根据公历（Gregorian）日历，不包括闰秒。

 日历时钟通常与NTP（网络时间协议）同步，这意味着来自一台机器的时间戳（理想情况下）与另一台机器上的时间戳相同。但是日历时钟也具有各种各样的奇特之处。如果本地时钟在NTP服务器之前太远，则它可能会被强制重置，可能是往前或往回跳一段时间。这些跳跃以及经常忽略闰秒的事实，使日历时钟不能用于测量一段持续时间的长短。

#### [单调钟](http://ddia.vonng.com/#/ch8?id=单调钟)

 单调钟适用于测量持续时间（时间间隔），例如超时或服务的响应时间：Linux上的`clock_gettime(CLOCK_MONOTONIC)`，和Java中的`System.nanoTime()`都是单调时钟。单调钟保证它总是往前走的，不会回跳。

 单调钟的绝对值是毫无意义的：它可能是计算机启动以来的纳秒数（Java），或类似的任意值。特别是比较来自两台不同计算机的单调钟的值是没有意义的，因为它们并不是一回事。

 在具有多个CPU插槽的服务器上，每个CPU可能有一个单独的计时器，但不一定与其他CPU同步。操作系统会补偿所有的差异，并尝试向应用线程表现出单调钟的样子，即使这些线程被调度到不同的CPU上。

 如果NTP协议检测到计算机的本地石英钟比NTP服务器要更快或更慢，则可以调整单调钟向前走的频率（这称为**偏移（skewing）** 时钟）。默认情况下，NTP允许时钟速率增加或减慢最高至0.05％，但NTP不能使单调时钟向前或向后跳转。单调时钟的分辨率通常相当好：在大多数系统中，它们能在几微秒或更短的时间内测量时间间隔。



